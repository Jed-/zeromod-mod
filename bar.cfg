delbar
addbar "Bud"
chatlog = "chat.txt"
onjoin = [ // cn
	cn = $arg1
	joinstr = (concatword "[join] " (getclientcolorname $cn) " has joined")
	if (!=s (getcountry $cn) "unknown") [
		joinstr = (concatword $joinstr " from ")
	]
	if (!=s (gettown $cn) "unknown") [
		joinstr = (concatword $joinstr (gettown $cn) ", ")
	]
	if (!=s (getregion $cn) "unknown") [
		joinstr = (concatword $joinstr (getregion $cn) ", ")
	]
	if (!=s (getcountry $cn) "unknown") [
		joinstr = (concatword $joinstr (getcountry $cn))
	]
	logto $chatlog $joinstr
]
onleave = [ // cn
	cn = $arg1
	leavestr = (concatword "[leave] " (getclientcolorname $cn) " has left")
	logto $chatlog $leavestr
]
onchat = [ // cn text
	cn = $arg1
	text = $arg2
	logto $chatlog (concatword (getclientcolorname $cn) ": " $text)
	barmen = []
	drunk = 0
	looplist c (listclients) [
		if (&& [isai $c] [isspectator $c]) [
			barmen = (concat $barmen $c)
		]
	]
	loop i (listlen $text) [
		botcn = -1
		looplist c $barmen [
			if (&& [= $botcn -1] [|| [=s (lowerstring (at $text $i)) (lowerstring (getclientname $c))] [=s (lowerstring (getword (at $text $i))) (lowerstring (getclientname $c))]]) [
				botcn = $c
			]
		]
		if (> $botcn -1) [ // "Bud"
			cmd = (lowerstring (getword (at $text (+ $i 1))))
			ishi = 0
			looplist hi $histrings [
				if (&& [! $ishi] [=s $cmd $hi]) [ // "Bud hi"
					ishi = 1
					barhi $botcn $cn
				]
			]
			if (&& $i [! $ishi]) [
				prev = (lowerstring (getword (at $text (- $i 1))))
				looplist hi $histrings [
					if (&& [! $ishi] [=s $hi $prev]) [
						ishi = 1
						barhi $botcn $cn
					]
				]
			]
			if (|| [=s $cmd "menu"] [=s $cmd "list"]) [ // "Bud menu"
				drinks0 = []
				looplist d $drinks [
					drinks0 = (concatword $drinks0 (at $d 0) " ")
				]
				barlist $botcn $cn $drinks0
			]
			drinkidx = -1
			loop i (listlen $drinks) [
				d = (at $drinks $i)
				if (&& [= $drinkidx -1] [|| [=s $cmd (at $d 0)] [=s $cmd (at $d 1)]]) [
					drinkidx = $i
				]
			]
			if (&& [! $drunk] [>= $drinkidx 0]) [ // "Bud beer"
				bardrink $botcn $cn (at (at $drinks $_drinkidx) 0) 1 $cn
				drunk = 1
			]
			if (|| [checknumber $cmd] [=s $cmd "a"] [=s $cmd "an"]) [ // "Bud a"
				num = $cmd
				if (|| [=s $num "a"] [=s $num "an"]) [
					num = 1
				]
				if (< $num 1) [
					num = 1
				]
				drink = (lowerstring (getword (at $text (+ $i 2))))
				drinkidx = -1
				loop i (listlen $drinks) [
					d = (at $drinks $i)
					if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
						drinkidx = $i
					]
				]
				if (&& [! $drunk] [>= $drinkidx 0]) [ // "Bud a beer"
					bardrink $botcn $cn (if (> $num 1) [result (at (at $drinks $drinkidx) 1)] [result (at (at $drinks $drinkidx) 0)]) $num $cn
					drunk = 1
				]
			]
			if (|| [=s $cmd "drink"] [=s $cmd "gimme"]) [ // "Bud drink"
				if (|| [checknumber (lowerstring (getword (at $text (+ $i 2))))] [=s (lowerstring (getword (at $text (+ $i 2)))) "a"] [=s (lowerstring (getword (at $text (+ $i 2)))) "an"]) [ // "Bud drink a"
					num = (lowerstring (getword (at $text (+ $i 2))))
					if (|| [=s $num "a"] [=s $num "an"]) [
						num = 1
					]
					if (< $num 1) [
						num = 1
					]
					drink = (lowerstring (getword (at $text (+ $i 3)))) // "Bud drink a beer"
					drinkidx = -1
					loop i (listlen $drinks) [
						d = (at $drinks $i)
						if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
							drinkidx = $i
						]
					]
					if (&& [! $drunk] [>= $drinkidx 0]) [
						bardrink $botcn $cn (if (> $num 1) [result (at (at $drinks $drinkidx) 1)] [result (at (at $drinks $drinkidx) 0)]) $num $cn
						drunk = 1
					]
				]
				drink = (lowerstring (getword (at $text (+ $i 2)))) // "Bud drink beer"
				drinkidx = -1
				loop i (listlen $drinks) [
					d = (at $drinks $i)
					if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
						drinkidx = $i
					]
				]
				if (&& [! $drunk] [>= $drinkidx 0]) [
					bardrink $botcn $cn (at (at $drinks $drinkidx) 0) 1 $cn
					drunk = 1
				]
			]
			if (|| [=s $cmd "give"] [=s $cmd "offer"]) [ // "Bud give"
				if (|| [checknumber (lowerstring (getword (at $text (+ $i 2))))] [=s (lowerstring (getword (at $text (+ $i 2)))) "a"] [=s (lowerstring (getword (at $text (+ $i 2)))) "an"]) [ // "Bud give a"
					num = (lowerstring (getword (at $text (+ $i 2))))
					if (|| [=s $num "a"] [=s $num "an"]) [
						num = 1
					]
					if (< $num 1) [
						num = 1
					]
					drink = (lowerstring (getword (at $text (+ $i 3)))) // "Bud give a beer"
					drinkidx = -1
					loop i (listlen $drinks) [
						d = (at $drinks $i)
						if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
							drinkidx = $i
						]
					]
					if (&& [! $drunk] [>= $drinkidx 0]) [
						bardrink $botcn $cn (if (> $num 1) [result (at (at $drinks $drinkidx) 1)] [result (at (at $drinks $drinkidx) 0)]) $num $cn
						drunk = 1
					]
				] [
					_to = (lowerstring (getword (at $text (+ $i 2))))
					tolist = []
					if (=s $_to "me") [ // "Bud give me"
						tolist = $cn
					]
					if (=s $tolist "") [
						looplist _cn (listclients) [
							if (=s $_to (lowerstring (getclientname $_cn))) [ // "Bud give Jed"
								tolist = (concat $tolist $_cn)
							]
						]
					]
					if (=s $tolist "") [
						looplist _cn (listclients) [
							if (>= (strstr (lowerstring (getclientname $_cn)) $_to) 0) [ // "Bud give J"
								tolist = (concat $tolist $_cn)
							]
						]
					]
					if (!=s $tolist "") [
						if (|| [checknumber (lowerstring (getword (at $text (+ $i 3))))] [=s (lowerstring (getword (at $text (+ $i 3)))) "a"] [=s (lowerstring (getword (at $text (+ $i 2)))) "an"]) [ // "Bud give me a"
							num = (lowerstring (getword (at $text (+ $i 3))))
							if (|| [=s $num "a"] [=s $num "an"]) [
								num = 1
							]
							if (< $num 1) [
								num = 1
							]
							drink = (lowerstring (getword (at $text (+ $i 4)))) // "Bud give me a beer"
							drinkidx = -1
							loop i (listlen $drinks) [
								d = (at $drinks $i)
								if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
									drinkidx = $i
								]
							]
							if (&& [! $drunk] [>= $drinkidx 0]) [
								looplist to $tolist [
									bardrink $botcn $to (if (> $num 1) [result (at (at $drinks $drinkidx) 1)] [result (at (at $drinks $drinkidx) 0)]) $num $cn
								]
								drunk = 1
							]
						]
						drink = (lowerstring (getword (at $text (+ $i 3)))) // "Bud give me beer"
						drinkidx = -1
						loop i (listlen $drinks) [
							d = (at $drinks $i)
							if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
								drinkidx = $i
							]
						]
						if (&& [! $drunk] [>= $drinkidx 0]) [
							looplist to $tolist [
								bardrink $botcn $to (at (at $drinks $drinkidx) 0) 1 $cn
							]
							drunk = 1
						]
					] [
						drink = (lowerstring (getword (at $text (+ $i 2)))) // "Bud give beer"
						drinkidx = -1
						loop i (listlen $drinks) [
							d = (at $drinks $i)
							if (&& [= $drinkidx -1] [|| [=s $drink (at $d 0)] [=s $drink (at $d 1)]]) [
								drinkidx = $i
							]
						]
						if (&& [! $drunk] [>= $drinkidx 0]) [
							bardrink $botcn $cn (at (at $drinks $drinkidx) 0) 1 $cn
							drunk = 1
						]
					]
				]
			]
		]
	]
]
getclientname = [ // _cn
	_cn = $arg1
	result (at (getclientcolorname $_cn) 0)
]
getword = [ // word
	word = $arg1
	word = (strreplace $word "," "")
	word = (strreplace $word "." "")
	word = (strreplace $word "?" "")
	word = (strreplace $word "!" "")
	word = (strreplace $word ":" "")
	word = (strreplace $word ";" "")
	result $word
]
histrings = ["hi" "hey" "hello"]
drinks = ["beer beers"]
barhi = [ // botcn clientcn
	botcn = $arg1
	cn = $arg2
	str = (concatword "Hey " (at (getclientcolorname $cn) 0) "!")
	fakesay $botcn $str
	logto $chatlog $str
]
barlist = [ // botcn cn list
	botcn = $arg1
	cn = $arg2
	list = $arg3
	str = (concatword "Here's the menu, " (at (getclientcolorname $cn) 0) ": " $list)
	fakesay $botcn $str
	logto $chatlog $str
]
bardrink = [ // botcn tocn item howmuch fromcn
	botcn = $arg1
	tocn = $arg2
	item = $arg3
	howmuch = $arg4
	fromcn = $arg5
	str = (concatword "Here" (? (= $howmuch 1) "'s" " are") (? (= $tocn $fromcn) " your " (concatword " " (? (= $howmuch 1) "a" $howmuch) " ")) $item (? (= $tocn $fromcn) (concatword ", " (at (getclientcolorname $cn) 0)) (concatword " for " (at (getclientcolorname $tocn) 0))) "!")
	fakesay $botcn $str
	logto $chatlog $str
	offer $fromcn $tocn $item $howmuch
]
parseirc = [ // chan buf
	chan = (unescape $arg1)
	buf = (unescape $arg2)
	barmen = []
	looplist cn (listclients) [
		if (&& [isai $cn] [isspectator $cn]) [
			barmen = (concat $barmen $cn)
		]
	]
	if (listlen $barmen) [
		barcn = (at $barmen 0)
		ircname = (at $buf 0)
		if (&& [=s (substr $ircname 0 1) "<"] [=s (substr $ircname (- (strlen $ircname) 1) 1) ">"]) [ // <name>
			_ircname = (substr $ircname 1 (- (strlen $ircname) 2))
			if (!=s $_ircname "Bud") [
				text = (substr $buf (+ (strlen $ircname) 1) (strlen $buf))
//				fakesay $barcn (concatword $_ircname ": " $text)
				fakesayas $barcn $_ircname $text
			]
		]
	] [
		barcn = (at $barmen 0)
		ircname = (at $buf 0)
		if (&& [=s (substr $ircname 0 1) "<"] [=s (substr $ircname (- (strlen $ircname) 1) 1) ">"]) [ // <name>
			_ircname = (substr $ircname 1 (- (strlen $ircname) 2))
			if (!=s $_ircname "Bud") [
				text = (substr $buf (+ (strlen $ircname) 1) (strlen $buf))
				zwall (concatword "^f1[^f7" $chan "^f1]^f7 " (concatword $_ircname ": " $text))
			]
		]
	]
	ircname = (at $buf 0)
	if (=s $ircname "><") [
		event = (at $buf 1)
		nick = $chan
		if (=s $event "JOIN") [
			channel = (at $buf (- (listlen $buf) 1))
			zwall (concatword "^f0join: ^f7" $nick " on ^f1" $channel)
		] [
			if (=s $event "PART") [
				channel = (substr (at $buf 1) 1 (- (strlen (at $buf 1)) 3))
				zwall (concatword "^f4leave: ^f7" $nick " from ^f1" $channel)
			] [
				if (=s $event "QUIT") [
					zwall (concatword "^f4leave: ^f7" $nick " from ^f1IRC network")
				]
			]
		]
	]
]
